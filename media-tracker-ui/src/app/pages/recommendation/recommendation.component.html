<div class="recommendation-page">
  <div class="page-container">
    <header class="page-header">
      <div class="title-group">
        <div class="icon-orb">
          <lucide-icon [img]="SparklesIcon" [size]="24"></lucide-icon>
        </div>
        <div>
          <h1>Media Discovery</h1>
          <p>Find your next obsession among {{ mediaType() === 1 ? 'anime' : 'games' }}</p>
        </div>
      </div>
    </header>

    <div class="discovery-grid">
      <!-- Filters Section -->
      <aside class="filters-card">
        <div class="card-header">
          <lucide-icon [img]="FilterIcon" [size]="16"></lucide-icon>
          <h2>Filters</h2>
        </div>

        <div class="filter-groups">
          <div class="filter-group">
            <label>Source</label>
            <div class="source-toggle">
              <button 
                [class.active]="source() === 'jikan'" 
                (click)="source.set('jikan')"
                [title]="mediaType() === 1 ? 'Jikan' : 'IGDB'">
                <lucide-icon [img]="GlobeIcon" [size]="14"></lucide-icon>
                <span>{{ mediaType() === 1 ? 'Jikan' : 'IGDB' }}</span>
              </button>
              <button 
                [class.active]="source() === 'backlog'" 
                (click)="source.set('backlog')"
                title="Backlog">
                <lucide-icon [img]="BookIcon" [size]="14"></lucide-icon>
                <span>Backlog</span>
              </button>
            </div>
          </div>

          <div class="filter-group">
            <label>Era</label>
            <ui-select 
              [options]="eraOptions()" 
              [(value)]="selectedDecadeValue" 
              placeholder="Any Era">
            </ui-select>
          </div>

          <div class="filter-group expandable" [class.expanded]="isGenresExpanded()">
            <div class="filter-header" (click)="isGenresExpanded.set(!isGenresExpanded())">
              <div class="label-group">
                <label>Genres</label>
                @if (selectedGenres().length > 0) {
                  <span class="count-badge">{{ selectedGenres().length }}</span>
                }
              </div>
              <lucide-icon [img]="ChevronDownIcon" [size]="14" class="chevron"></lucide-icon>
            </div>

            @if (getSelectedGenreObjects().length > 0) {
              <div class="selected-genres-list">
                @for (genre of getSelectedGenreObjects(); track genre.mal_id) {
                  <app-tag-chip 
                    [label]="genre.name" 
                    [icon]="getGenreIcon(genre.name)" 
                    [active]="true" 
                    [removable]="true"
                    (clicked)="toggleGenre(genre.mal_id)">
                  </app-tag-chip>
                }
              </div>
            }
            
            <div class="expand-content">
              <div class="genres-grid">
                @for (genre of getUnselectedGenres(); track genre.mal_id) {
                  <app-tag-chip 
                    [label]="genre.name" 
                    [icon]="getGenreIcon(genre.name)" 
                    (clicked)="toggleGenre(genre.mal_id)">
                  </app-tag-chip>
                }
              </div>
            </div>
          </div>

          <div class="filter-group expandable" [class.expanded]="isPlatformsExpanded()" *ngIf="mediaType() === 3">
            <div class="filter-header" (click)="isPlatformsExpanded.set(!isPlatformsExpanded())">
              <div class="label-group">
                <label>Platforms</label>
                @if (selectedPlatforms().length > 0) {
                  <span class="count-badge">{{ selectedPlatforms().length }}</span>
                }
              </div>
              <lucide-icon [img]="ChevronDownIcon" [size]="14" class="chevron"></lucide-icon>
            </div>

            @if (selectedPlatforms().length > 0) {
              <div class="selected-genres-list">
                @for (platform of platforms(); track platform.id) {
                  @if (selectedPlatforms().includes(platform.id)) {
                    <app-tag-chip 
                      [label]="platform.name" 
                      [active]="true"
                      [removable]="true"
                      (clicked)="togglePlatform(platform.id)">
                    </app-tag-chip>
                  }
                }
              </div>
            }

            <div class="expand-content">
              <div class="genres-grid">
                @for (platform of platforms(); track platform.id) {
                  @if (!selectedPlatforms().includes(platform.id)) {
                    <app-tag-chip 
                      [label]="platform.name" 
                      (clicked)="togglePlatform(platform.id)">
                    </app-tag-chip>
                  }
                }
              </div>
            </div>
          </div>
        </div>

        <button class="generate-btn" (click)="getRecommendation()" [disabled]="isLoading()">
          <lucide-icon [img]="isLoading() ? RefreshIcon : SparklesIcon" [size]="16" [class.spinning]="isLoading()"></lucide-icon>
          <span>{{ isLoading() ? 'Finding...' : 'Surprise Me!' }}</span>
        </button>
      </aside>

      <!-- Result Section -->
      <main class="result-area">
        @if (recommendedAnime()) {
          @let item = recommendedAnime();
          <div class="recommendation-card" [class.animate-in]="recommendedAnime()">
            <div class="anime-hero">
              <img [src]="getImageUrl(item)" [alt]="item.title || item.name" class="hero-image">
              <div class="hero-overlay">
                <div class="meta-badges">
                  <span class="score-badge" *ngIf="item.score || item.rating">
                    ‚≠ê {{ item.score || (item.rating / 10 | number:'1.1-1') }}
                  </span>
                  <span class="year-badge">
                    {{ item.releaseYear || item.year || (item.first_release_date ? (item.first_release_date * 1000 | date:'yyyy') : '') }}
                  </span>
                </div>
              </div>
            </div>
            <div class="anime-details">
              <h1>{{ item.title || item.name }}</h1>
              
              <div class="genres-list">
                @for (genre of (item.genres || []); track genre) {
                  <app-tag-chip 
                    [label]="genre.name || genre" 
                    [icon]="getGenreIcon(genre.name || genre)">
                  </app-tag-chip>
                }
              </div>

              <div class="genres-list" *ngIf="item.platforms?.length">
                @for (platform of (item.platforms || []); track (platform.name || platform)) {
                  <app-tag-chip 
                    class="platform-tag-wrapper"
                    [label]="platform.name || platform" 
                    [icon]="MonitorIcon">
                  </app-tag-chip>
                }
              </div>

              <div class="synopsis" *ngIf="item.synopsis || item.summary">
                <p>{{ item.synopsis || item.summary }}</p>
              </div>

              <div class="card-footer-actions">
                <div class="category-selector-wrapper">
                  <lucide-icon [img]="LayersIcon" [size]="14"></lucide-icon>
                  <select [(ngModel)]="selectedCategory" class="inline-select">
                    @for (cat of categories(); track cat.id) {
                      <option [ngValue]="cat">{{ cat.name }}</option>
                    }
                  </select>
                </div>

                <div class="footer-buttons">
                  <button class="primary-action" (click)="addToLibrary()">
                    <lucide-icon [img]="PlusIcon" [size]="16"></lucide-icon>
                    <span>Add to {{ selectedCategory()?.name }}</span>
                  </button>
                  <button class="secondary-action" (click)="getRecommendation()" title="Try Another">
                    <lucide-icon [img]="RefreshIcon" [size]="16"></lucide-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        } @else if (isLoading()) {
          <div class="placeholder-state loading">
            <div class="magic-spinner">
              <lucide-icon [img]="SparklesIcon" [size]="40"></lucide-icon>
            </div>
            <h2>Magic happens...</h2>
          </div>
        } @else {
          <div class="placeholder-state">
            <div class="icon-bounce">
              <lucide-icon [img]="SearchIcon" [size]="48"></lucide-icon>
            </div>
            <h2>Ready?</h2>
            <p>Pick your filters and click "Surprise Me!"</p>
          </div>
        }
      </main>
    </div>
  </div>
</div>
