<app-stats-header
  [selectedYear]="selectedYear()"
  [yearOptions]="yearOptions()"
  [completedMedia]="completedMediaList()"
  (yearChange)="onYearChange($event)">
</app-stats-header>

<div class="stats-container">
  <!-- Stats Cards -->
  <app-stats-summary-cards
    [totalStarted]="stats().totalStarted"
    [totalCompleted]="stats().totalCompleted"
    [totalEpisodes]="stats().totalEpisodes"
    [totalTime]="stats().totalTime">
  </app-stats-summary-cards>

  <!-- Status Distribution -->
  <app-stats-distribution
    [title]="'Status'"
    [unitLabel]="currentMediaType() === MediaType.ANIME ? 'Anime' : 'Games'"
    [stats]="categoryStats()"
    [total]="stats().totalAnime">
  </app-stats-distribution>

    <!-- Top Stats Groups -->
  <div class="stats-bar-grid">
    <app-stats-bar-list
      title="Gêneros"
      [data]="stats().favoriteGenres"
      color="var(--app-primary)">
    </app-stats-bar-list>

    @if (currentMediaType() === MediaType.ANIME) {
      <app-stats-bar-list
        title="Estúdios"
        [data]="producerStats()"
        color="var(--app-primary)">
      </app-stats-bar-list>
    }

    @if (currentMediaType() !== MediaType.ANIME) {
      <app-stats-bar-list
        title="Plataformas"
        [data]="platformStats()"
        color="var(--app-primary)">
      </app-stats-bar-list>
    }

    <app-stats-bar-list
      title="Ano de Lançamento"
      [data]="releaseYearStats()"
      color="var(--app-primary)">
    </app-stats-bar-list>
  </div>

  @if (selectedYear() !== 'all') {
    <div class="stats-diary-section">
      <app-stats-diary
        [selectedYear]="selectedYear()"
        [mediaList]="allMedia()"
        [mediaType]="currentMediaType()">
      </app-stats-diary>
    </div>
  }

  <!-- Top Rated Anime -->
  @if (stats().topRated.length > 0) {
    <section class="anime-grid-section">
      <h2>Top Rated</h2>
      <div class="anime-grid">
        @for (item of stats().topRated; track item.id) {
          <div class="anime-card">
            <img [src]="item.coverImage" [alt]="item.title">
            <div class="anime-overlay">
              <h3>{{ item.title }}</h3>
              <div class="anime-score">
                <lucide-icon [img]="StarIcon" [size]="14"></lucide-icon>
                {{ item.score }}
              </div>
            </div>
          </div>
        }
      </div>
    </section>
  }

  <!-- Recently Completed -->
  @if (stats().recentlyCompleted.length > 0) {
    <section class="anime-grid-section">
      <h2>Recently Completed</h2>
      <div class="anime-grid">
        @for (item of stats().recentlyCompleted; track item.id) {
          <div class="anime-card">
            <img [src]="item.coverImage" [alt]="item.title">
            <div class="anime-overlay">
              <h3>{{ item.title }}</h3>
              @if (item.score > 0) {
                <div class="anime-score">
                  <lucide-icon [img]="StarIcon" [size]="14"></lucide-icon>
                  {{ item.score }}
                </div>
              }
            </div>
          </div>
        }
      </div>
    </section>
  }

  <!-- Completion Rate -->
  <section class="completion-section">
    <h2>Completion Rate</h2>
    <div class="completion-card">
      <div class="completion-circle">
        <svg viewBox="0 0 120 120" width="120" height="120">
          <circle 
            cx="60" cy="60" r="50" 
            fill="none" 
            stroke="var(--app-surface-light)" 
            stroke-width="10">
          </circle>
          <circle 
            cx="60" cy="60" r="50" 
            fill="none" 
            stroke="var(--app-primary)" 
            stroke-width="10"
            stroke-linecap="round"
            [attr.stroke-dasharray]="314.16"
            [attr.stroke-dashoffset]="314.16 - (314.16 * completionPercentage() / 100)"
            transform="rotate(-90 60 60)">
          </circle>
        </svg>
        <div class="completion-text">
          <span class="percentage">{{ completionPercentage() }}%</span>
          <span class="label">Complete</span>
        </div>
      </div>
      <div class="completion-stats">
        <div class="stat">
          <span class="stat-value">{{ stats().totalCompleted }}</span>
          <span class="stat-label">Completed</span>
        </div>
        <div class="stat">
          <span class="stat-value">{{ stats().totalAnime - stats().totalCompleted }}</span>
          <span class="stat-label">In Progress</span>
        </div>
      </div>
    </div>
  </section>



  <!-- All Watched Media -->
  @if (getAllWatchedMedia().length > 0) {
    <section class="all-watched-section">
      <h2>
        {{ currentMediaType() === MediaType.GAME ? 'Todos os Games Jogados' : 'Todos os Anime Assistidos' }}
        <span class="count-badge">{{ getAllWatchedMedia().length }}</span>
      </h2>
      <div class="all-watched-grid">
        @for (item of getAllWatchedMedia(); track item.id) {
          <div class="watched-card">
            <img [src]="item.coverImage" [alt]="item.title">
            <div class="watched-overlay">
              <h3>{{ item.title }}</h3>
              <div class="watched-info">
                <span class="episodes">
                  {{ item.progressCurrent }}
                  @if (currentMediaType() === MediaType.ANIME) { /{{ item.progressTotal || '?' }} eps }
                  @else { hrs }
                </span>
                @if (item.score > 0) {
                  <span class="score">
                    <lucide-icon [img]="StarIcon" [size]="12"></lucide-icon>
                    {{ item.score }}
                  </span>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </section>
  }
  
  <ui-scroll-to-top></ui-scroll-to-top>
</div>
