<div class="browse-page">
  <!-- Featured Hero Carousel -->
  <!-- Featured Hero Carousel -->
  <section class="hero-section" #heroOrigin>
    @if (currentFeatured; as featured) {
      <div class="hero-backdrop" 
           [class.transitioning]="isTransitioning()"
           [style.background-image]="'url(' + (featured.bannerImage || featured.image) + ')'">
        <div class="hero-gradient"></div>
      </div>
      
      <div class="hero-content" [class.transitioning]="isTransitioning()">
        <div class="hero-info">
          <h1 class="hero-title">{{ featured.title }}</h1>
          
          <div class="hero-meta">
            @if (featured.score) {
              <span class="meta-item">
                <lucide-icon [img]="StarIcon" [size]="16"></lucide-icon>
                {{ featured.score }}
              </span>
            }
            @if (featured.year) {
              <span class="meta-item">{{ featured.year }}</span>
            }
            @if (featured.type) {
              <span class="meta-item">{{ featured.type }}</span>
            }
          </div>

          @if (featured.synopsis) {
            <p class="hero-synopsis">{{ featured.synopsis }}</p>
          }

          <div class="hero-genres">
            @for (genre of featured.genres.slice(0, 3); track $index) {
              <span class="genre-badge">{{ genre }}</span>
            }
          </div>

          <div class="hero-actions">
            <button class="hero-btn primary" (click)="viewDetails(featured)">
              <lucide-icon [img]="SparklesIcon" [size]="18"></lucide-icon>
              <span>View Details</span>
            </button>
            
            <div class="hero-action-group">
              <button class="action-btn" [class.added]="isItemAdded(featured.externalId)" 
                (click)="quickAddMedia(featured); $event.stopPropagation()"
                [title]="isItemAdded(featured.externalId) ? 'Adicionado à biblioteca' : 'Adicionar aos Desejos'">
                <lucide-icon [img]="isItemAdded(featured.externalId) ? CheckIcon : BookmarkIcon" [size]="20"></lucide-icon>
              </button>

              <button class="action-btn" (click)="toggleHeroListMenu($event)" title="Adicionar a uma lista">
                <lucide-icon [img]="ListPlusIcon" [size]="20"></lucide-icon>
              </button>

              @if (featured.trailerUrl) {
                <button class="action-btn" (click)="playTrailer(featured)" title="Ver Trailer">
                  <lucide-icon [img]="PlayIcon" [size]="20"></lucide-icon>
                </button>
              }
            </div>
          </div>
        </div>

        <!-- Carousel Controls -->
        <div class="carousel-controls">
          <button class="carousel-btn" (click)="prevFeatured()" [disabled]="isTransitioning()">
            <lucide-icon [img]="ChevronLeftIcon" [size]="20"></lucide-icon>
          </button>
          
          <div class="carousel-dots">
            @for (item of featuredList(); track $index) {
              <button 
                class="dot" 
                [class.active]="currentFeaturedIndex() === $index"
                [disabled]="isTransitioning()"
                (click)="selectFeatured($index)">
              </button>
            }
          </div>
          
          <button class="carousel-btn" (click)="nextFeatured()" [disabled]="isTransitioning()">
            <lucide-icon [img]="ChevronRightIcon" [size]="20"></lucide-icon>
          </button>
        </div>
      </div>

      <app-popover 
        [origin]="heroOrigin" 
        [isOpen]="showHeroListMenu()" 
        (close)="showHeroListMenu.set(false)"
        [customStyle]="{ width: '18rem', height: '24rem' }">
        <div class="list-menu" (click)="$event.stopPropagation()">
          <div class="menu-header">
            <span>Adicionar à Lista</span>
            <button class="close-btn" (click)="showHeroListMenu.set(false)">
              <lucide-icon [img]="XIcon" [size]="14"></lucide-icon>
            </button>
          </div>

          <div class="menu-content">
            <div class="list-options">
              @for (list of availableLists(); track list.id) {
                <button class="list-option" (click)="addToListFromHero(list, featured)">
                  {{ list.name }}
                </button>
              }
            </div>

            <div class="new-list-section">
              @if (isCreatingList()) {
                <div class="create-list-form">
                  <input type="text" [(ngModel)]="newListName" placeholder="Nome da lista..." (keyup.enter)="createAndAddListFromHero($event)"
                    autofocus>
                  <div class="form-actions">
                    <button class="cancel-btn" (click)="isCreatingList.set(false)">Cancelar</button>
                    <button class="save-btn" (click)="createAndAddListFromHero($event)" [disabled]="!newListName.trim()">Criar</button>
                  </div>
                </div>
              } @else {
                <button class="create-toggle-btn" (click)="isCreatingList.set(true)">
                  <lucide-icon [img]="PlusIcon" [size]="14"></lucide-icon>
                  <span>Criar Nova Lista</span>
                </button>
              }
            </div>
          </div>
        </div>
      </app-popover>

    } @else if (isLoadingFeatured()) {
      <div class="hero-skeleton">
        <div class="skeleton-content">
          <div class="h-title"></div>
          <div class="h-meta"></div>
          <div class="h-desc"></div>
          <div class="h-btns">
            <div class="h-btn"></div>
            <div class="h-btn"></div>
          </div>
        </div>
      </div>
    }
  </section>

  <!-- Scrollable Sections -->
  <div class="sections-container">
    @if (searchQuery()) {
      <section class="anime-section search-results-section">
        <div class="section-header">
          <div class="section-title-group">
            <lucide-icon [img]="SearchIcon" [size]="20" class="section-icon search-icon"></lucide-icon>
            <div>
              <h2>Resultados para: "{{ searchQuery() }}"</h2>
              <p class="section-subtitle">Encontrados na web</p>
            </div>
          </div>
          <button class="clear-search-btn" (click)="searchQuery.set(''); searchResults.set([])">
            <lucide-icon [img]="XIcon" [size]="18"></lucide-icon>
            <span>Limpar Busca</span>
          </button>
        </div>

        <div class="items-wrapper">
          <div class="items-scroller">
            @if (isSearching()) {
              @for (i of [1,2,3,4,5]; track i) {
                <div class="card-skeleton">
                  <div class="skeleton-image"></div>
                  <div class="skeleton-info">
                    <div class="skeleton-title"></div>
                    <div class="skeleton-meta"></div>
                  </div>
                </div>
              }
            } @else {
              @if (searchResults().length === 0) {
                <div class="no-results">
                  <p>Nenhum resultado encontrado para sua busca.</p>
                </div>
              } @else {
                @for (item of searchResults(); track item.externalId) {
                  <app-browse-card 
                    [item]="item" 
                    [isAdded]="isItemAdded(item.externalId)"
                    [categories]="categories()"
                    [showCategoryTooltip]="showCategoryTooltip() === item.externalId"
                    (viewDetails)="viewDetails($event)"
                    (quickAdd)="quickAddMedia($event)"
                    (changeCategory)="changeCategory($event.item, $event.category)"
                    (closeTooltip)="closeTooltip()"
                    (playTrailer)="playTrailer($event)"
                    (addToListEvent)="handleAddToList($event)">
                  </app-browse-card>
                }
              }
            }
          </div>
        </div>
      </section>
    }

    <!-- Refresh Button -->
    <div class="refresh-section" *ngIf="!searchQuery()">
      <button class="refresh-btn" (click)="refreshBrowse()" title="Clear cache and reload">
        <lucide-icon [img]="RefreshIcon" [size]="18"></lucide-icon>
        <span>Atualizar Conteúdo</span>
      </button>
      <p class="cache-hint">Os dados são armazenados em cache por 2 horas.</p>
    </div>

    @for (section of sections(); track $index) {
      <section class="anime-section section-{{$index}}">
        <div class="section-header">
          <div class="section-title-group">
            <lucide-icon [img]="section.icon" [size]="20" class="section-icon"></lucide-icon>
            <div>
              <h2>{{ section.title }}</h2>
              @if (section.subtitle) {
                <p class="section-subtitle">{{ section.subtitle }}</p>
              }
            </div>
          </div>

          @if (section.availableSorts) {
            <div class="section-sort">
              <ui-select 
                [value]="section.currentSort" 
                [options]="section.availableSorts || []"
                (valueChange)="changeSectionSort($index, $event)"
                align="right">
              </ui-select>
            </div>
          }
        </div>

        <div class="items-wrapper">
          <button class="scroll-btn left" (click)="scrollSection($index, 'left')" [style.display]="section.isLoading ? 'none' : 'flex'">
            <lucide-icon [img]="ChevronLeftIcon" [size]="24"></lucide-icon>
          </button>
          
          <div class="items-scroller">
            @if (section.isLoading) {
              @for (i of [1,2,3,4,5,6,7,8,9,10]; track i) {
                <div class="card-skeleton">
                  <div class="skeleton-image"></div>
                  <div class="skeleton-info">
                    <div class="skeleton-title"></div>
                    <div class="skeleton-meta"></div>
                  </div>
                </div>
              }
            } @else {
              @for (item of section.items; track item.externalId) {
                <app-browse-card 
                  [item]="item" 
                  [isAdded]="isItemAdded(item.externalId)"
                  [categories]="categories()"
                  [showCategoryTooltip]="showCategoryTooltip() === item.externalId"
                  (viewDetails)="viewDetails($event)"
                  (quickAdd)="quickAddMedia($event)"
                  (changeCategory)="changeCategory($event.item, $event.category)"
                  (closeTooltip)="closeTooltip()"
                  (playTrailer)="playTrailer($event)"
                  (addToListEvent)="handleAddToList($event)">
                </app-browse-card>
              }
            }
          </div>

          <button class="scroll-btn right" (click)="scrollSection($index, 'right')" [style.display]="section.isLoading ? 'none' : 'flex'">
            <lucide-icon [img]="ChevronRightIcon" [size]="24"></lucide-icon>
          </button>
        </div>
      </section>
    }
  </div>

  <!-- Trailer Overlay -->
  @if (selectedTrailer(); as trailer) {
    <app-trailer-overlay
      [trailerUrl]="trailer.url"
      [title]="trailer.title"
      (close)="selectedTrailer.set(null)">
    </app-trailer-overlay>
  }
</div>
