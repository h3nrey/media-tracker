<div class="anime-card" #cardOrigin>
  <div class="card-image-wrapper" (click)="viewDetails.emit(item)">
    <img [src]="item.image" [alt]="item.title" class="card-image">

    @if (item.score) {
      <div class="score-badge">
        <lucide-icon [img]="StarIcon" [size]="12"></lucide-icon>
        {{ item.score }}
      </div>
    }

    <!-- Quick Add Button -->
    <button class="quick-add-btn" [class.added]="isAdded" (click)="onCategoryClick($event)"
      [title]="isAdded ? 'Mudar Status' : 'Adicionar Ã  biblioteca'">
      <lucide-icon [img]="isAdded ? CheckIcon : BookmarkIcon" [size]="16">
      </lucide-icon>
    </button>

    <!-- Add to List Button -->
    <button class="add-to-list-btn" (click)="toggleActionMenu($event, 'lists')" title="Adicionar a uma lista">
      <lucide-icon [img]="ListPlusIcon" [size]="16"></lucide-icon>
    </button>

    <!-- Play Trailer Button -->
    @if (item.trailerUrl) {
      <button class="play-trailer-btn" (click)="playTrailer.emit(item); $event.stopPropagation()" title="Ver Trailer">
        <lucide-icon [img]="PlayIcon" [size]="20"></lucide-icon>
      </button>
    }

  </div>

  <!-- Unified Action Menu -->
  <app-popover 
    [origin]="cardOrigin" 
    [isOpen]="showActionMenu()" 
    (close)="showActionMenu.set(false)"
    [customStyle]="{ width: '16rem', height: '22rem' }">
    <app-browse-list-popover
      [availableLists]="availableLists()"
      [categories]="categories"
      [initialView]="actionMenuInitialView()"
      (close)="showActionMenu.set(false)"
      (selectList)="onSelectList($event)"
      (selectCategory)="onSelectCategory($event)"
      (createList)="onCreateList($event)">
    </app-browse-list-popover>
  </app-popover>
  <div class="card-info" (click)="viewDetails.emit(item)">
    <h3 class="card-title">{{ item.title }}</h3>
    <p class="card-meta">{{ item.year || 'N/A' }}</p>
  </div>
</div>
