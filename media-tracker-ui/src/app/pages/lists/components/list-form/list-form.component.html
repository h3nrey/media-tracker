@if (isOpen()) {
  <div class="dialog-overlay" (click)="closeDialog()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <header class="dialog-header">
        <h2>{{ editingListId() ? 'Edit List' : 'Create New List' }}</h2>
        <button class="close-btn" (click)="closeDialog()">
          <lucide-icon [img]="XIcon" [size]="20"></lucide-icon>
        </button>
      </header>

      <div class="form-body">
        <div class="form-group">
          <label>List Name</label>
          <input 
            type="text" 
            [(ngModel)]="name" 
            placeholder="Enter list name..."
            class="form-input"
          >
        </div>

        <div class="form-group">
          <label>Folder (Optional)</label>
          <select [(ngModel)]="selectedFolderId" class="form-select">
            <option [ngValue]="undefined">No Folder</option>
            @for (folder of folders(); track folder.id) {
              <option [ngValue]="folder.id">{{ folder.name }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label>List Type</label>
          <select [(ngModel)]="mediaTypeId" class="form-input">
            @for (opt of mediaTypeOptions; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
            }
          </select>
          <small class="form-hint">Universal lists appear everywhere. Typed lists only show when that media type is selected.</small>
        </div>

        <div class="form-group">
          <label>Add Media</label>
          <div class="search-container">
            <lucide-icon [img]="SearchIcon" [size]="18" class="search-icon"></lucide-icon>
            <input 
              type="text" 
              [(ngModel)]="searchQuery" 
              (ngModelChange)="onSearchChange($event)"
              placeholder="Search library or Global (MAL/IGDB)..."
              class="form-input search-input"
            >
            @if (isSearching()) {
              <div class="search-loader">
                <div class="spinner"></div>
              </div>
            }
            
            @if (filteredLocalMedia.length > 0 || filteredApiResults.length > 0) {
              <div class="search-results">
                @if (filteredLocalMedia.length > 0) {
                  <div class="results-section">
                    <div class="section-label">Your Library</div>
                    @for (media of filteredLocalMedia; track media.id) {
                      <div class="search-item" (click)="addMedia(media.id!)">
                        <img [src]="media.coverImage" [alt]="media.title" class="item-thumb">
                        <div class="item-info">
                          <span class="title">{{ media.title }}</span>
                          <span class="meta">
                            {{ media.releaseYear || '?' }} 
                            @if (media.mediaTypeId === 1) { • {{ media.progressTotal || '?' }} Eps }
                            @if (media.mediaTypeId === 3) { • Game }
                          </span>
                        </div>
                        <lucide-icon [img]="PlusIcon" [size]="16" class="add-icon"></lucide-icon>
                      </div>
                    }
                  </div>
                }

                @if (filteredApiResults.length > 0) {
                  <div class="results-section">
                    <div class="section-label">Global Search (Add to Library)</div>
                    @for (item of filteredApiResults; track item.id || item.mal_id) {
                      <div class="search-item api-item" (click)="addMediaFromApi(item)">
                        @if (item._type === 'anime') {
                          <img [src]="item.images.webp.small_image_url || item.images.jpg.small_image_url" [alt]="item.title" class="item-thumb">
                          <div class="item-info">
                            <span class="title">{{ item.title_english || item.title }}</span>
                            <span class="meta">{{ item.year || '?' }} • {{ item.episodes || '?' }} Eps (Anime)</span>
                          </div>
                        } @else {
                          <img [src]="item.cover?.url ? 'https:' + item.cover.url : ''" [alt]="item.name" class="item-thumb">
                          <div class="item-info">
                            <span class="title">{{ item.name }}</span>
                            <span class="meta">{{ item.first_release_date ? (item.first_release_date * 1000 | date:'yyyy') : '?' }} • Game</span>
                          </div>
                        }
                        <lucide-icon [img]="PlusIcon" [size]="16" class="add-icon"></lucide-icon>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <div class="selected-animes">
          <label>Selected Animes ({{ selectedAnimes().length }})</label>
          <div class="anime-list">
            @for (item of selectedAnimes(); track item.id) {
              <div class="anime-chip">
                <img [src]="item.coverImage" [alt]="item.title">
                <span class="anime-title">{{ item.title }}</span>
                <button class="remove-btn" (click)="$event.stopPropagation(); removeMedia(item.id!)">
                  <lucide-icon [img]="TrashIcon" [size]="14"></lucide-icon>
                </button>
              </div>
            }
            @if (selectedAnimes().length === 0) {
              <div class="empty-selection">No animes added yet.</div>
            }
          </div>
        </div>

        <div class="selected-animes">
          <label>Selected Games ({{ selectedGames().length }})</label>
          <div class="anime-list">
            @for (item of selectedGames(); track item.id) {
              <div class="anime-chip">
                <img [src]="item.coverImage" [alt]="item.title">
                <span class="anime-title">{{ item.title }}</span>
                <button class="remove-btn" (click)="$event.stopPropagation(); removeMedia(item.id!)">
                  <lucide-icon [img]="TrashIcon" [size]="14"></lucide-icon>
                </button>
              </div>
            }
            @if (selectedGames().length === 0) {
              <div class="empty-selection">No games added yet.</div>
            }
          </div>
        </div>
      </div>

      <footer class="dialog-footer">
        <button class="btn-cancel" (click)="closeDialog()">Cancel</button>
        <button 
          class="btn-save" 
          (click)="save()"
          [disabled]="!name()"
        >
          {{ editingListId() ? 'Save Changes' : 'Create List' }}
        </button>
      </footer>
    </div>
  </div>
}
