@if (isOpen()) {
  <div class="dialog-overlay" (click)="close()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      
      <div class="dialog-header">
        <div class="header-main">
          <div class="header-icon-wrapper">
            @if (selectedMediaType() === 1) { <lucide-icon [img]="PlayIcon" class="icon-anime"></lucide-icon> }
            @else if (selectedMediaType() === 2) { <lucide-icon [img]="BookIcon" class="icon-manga"></lucide-icon> }
            @else if (selectedMediaType() === 3) { <lucide-icon [img]="GameIcon" class="icon-game"></lucide-icon> }
            @else if (selectedMediaType() === 4) { <lucide-icon [img]="FilmIcon" class="icon-movie"></lucide-icon> }
          </div>
          <div class="header-titles">
            <h2>{{ dialogTitle() }}</h2>
            <p class="header-subtitle">Manage your {{ dialogTitle().split(' ')[1].toLowerCase() }} details</p>
          </div>
        </div>
        <button class="close-btn" (click)="close()">
          <lucide-icon [img]="XIcon" [size]="20"></lucide-icon>
        </button>
      </div>

      <div class="dialog-body">
        @if (!manualMode() && !selectedMediaApiResult()) {
          <div class="body-scroll-container">
            <div class="search-section">
              <div class="search-input-wrapper">
                <lucide-icon [img]="SearchIcon" class="search-icon"></lucide-icon>
                <input
                  type="text"
                  class="premium-search-input"
                  [placeholder]="searchPlaceholder()"
                  [value]="searchQuery()"
                  (input)="onSearchInput($any($event.target).value)"
                  autofocus
                />
              </div>

              @if (isSearching()) {
                <div class="searching-state">
                  <div class="loader-ring"></div>
                  <span>Searching database...</span>
                </div>
              }

              @if (searchResults().length > 0) {
                <div class="search-results-grid">
                  @for (media of searchResults(); track media.id || media.mal_id) {
                    <div class="premium-result-card" (click)="selectMediaFromApi(media)">
                      <div class="result-cover-wrapper">
                        <img [src]="getResultCover(media)" [alt]="getResultTitle(media)" />
                      </div>
                      <div class="result-details">
                        <span class="result-name">{{ getResultTitle(media) }}</span>
                        <div class="result-meta-info">
                          <span class="meta-tag">{{ getResultMeta(media) }}</span>
                          @if (getResultYear(media)) {
                            <span class="meta-separator">â€¢</span>
                            <span class="meta-year">{{ getResultYear(media) }}</span>
                          }
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }

              @if(!isSearching()) {
              <div class="search-empty-action">
                <p>Can't find what you're looking for?</p>
                <button class="manual-trigger-btn" (click)="enableManualMode()">
                  <lucide-icon [img]="PlusIcon" [size]="16"></lucide-icon>
                  Add Details Manually
                </button>
              </div>
            }
            </div>
          </div>
        }

        @if (manualMode() || selectedMediaApiResult()) {
          <div class="body-full-container">
            @if (selectedMediaType() === 1) {
              <app-anime-form 
                [initialData]="initialFormData()" 
                [categories]="categories()"
                [sources]="sources()"
                [isSaving]="isSaving()"
                (save)="onSave($event)"
                (cancel)="close()"
                (changeSource)="enableSearchMode()"
              ></app-anime-form>
            } @else if (selectedMediaType() === 2) {
              <app-manga-form 
                [initialData]="initialFormData()" 
                [categories]="categories()"
                [sources]="sources()"
                [isSaving]="isSaving()"
                (save)="onSave($event)"
                (cancel)="close()"
              ></app-manga-form>
            } @else if (selectedMediaType() === 3) {
              <app-game-form 
                [initialData]="initialFormData()" 
                [categories]="categories()"
                [sources]="sources()"
                [isSaving]="isSaving()"
                (save)="onSave($event)"
                (cancel)="close()"
                (changeSource)="enableSearchMode()"
              ></app-game-form>
            } @else if (selectedMediaType() === 4) {
              <app-movie-form 
                [initialData]="initialFormData()" 
                [categories]="categories()"
                [sources]="sources()"
                [isSaving]="isSaving()"
                (save)="onSave($event)"
                (cancel)="close()"
              ></app-movie-form>
            }
          </div>
        }
      </div>
    </div>
  </div>
}
