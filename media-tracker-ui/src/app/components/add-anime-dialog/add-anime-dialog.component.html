@if (isOpen()) {
  <div class="dialog-overlay" (click)="close()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>{{ dialogTitle() }}</h2>
        <button class="close-btn" (click)="close()">&times;</button>
      </div>

      <div class="dialog-body">
        @if (!manualMode() && !selectedAnime()) {
          <div class="search-section">
            <input
              type="text"
              class="search-input"
              placeholder="Search MyAnimeList..."
              [value]="searchQuery()"
              (input)="onSearchInput($any($event.target).value)"
              autofocus
            />

            @if (isSearching()) {
              <div class="searching">Searching...</div>
            }

            @if (searchResults().length > 0) {
              <div class="search-results">
                @for (anime of searchResults(); track anime.mal_id) {
                  <div class="search-result-item" (click)="selectAnime(anime)">
                    <img
                      [src]="anime.images.webp.small_image_url || anime.images.jpg.small_image_url"
                      [alt]="anime.title"
                      class="result-image"
                    />
                    <div class="result-info">
                      <div class="result-title">{{ anime.title }}</div>
                      <div class="result-meta">
                        {{ anime.type }} • {{ anime.episodes || '?' }} eps
                        @if (anime.year) {
                          • {{ anime.year }}
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            }

            <button class="manual-btn" (click)="enableManualMode()">
              Or add manually
            </button>
          </div>
        }

        @if (manualMode() || selectedAnime()) {
          <div class="form-section">
            @if (selectedAnime()) {
              <div class="selected-anime-preview">
                <img
                  [src]="coverImage()"
                  [alt]="title()"
                  class="preview-image"
                />
                <div>
                  <strong>{{ title() }}</strong>
                  <button class="change-btn" (click)="enableManualMode()">
                    Change
                  </button>
                </div>
              </div>
            }

            <div class="form-grid">
              <!-- Category - Emphasized at Top -->
              <div class="form-group full-width category-section">
                <label>Category</label>
                <select
                  class="category-select-large"
                  [value]="selectedCategoryId()"
                  (change)="selectedCategoryId.set(+$any($event.target).value)"
                >
                  @for (category of categories(); track category.id) {
                    <option [value]="category.id">{{ category.name }}</option>
                  }
                </select>
              </div>

              <div class="form-group full-width">
                <label>Title *</label>
                <input
                  type="text"
                  [value]="title()"
                  (input)="title.set($any($event.target).value)"
                  required
                />
              </div>

              <div class="form-group full-width">
                <label>Cover Image URL</label>
                <div class="cover-input-group">
                  <input
                    type="text"
                    [value]="coverImage()"
                    (input)="coverImage.set($any($event.target).value)"
                    placeholder="https://..."
                  />
                  @if (coverImage()) {
                    <div class="cover-preview-mini">
                      <img [src]="coverImage()" alt="Preview" />
                    </div>
                  }
                </div>
              </div>

              <div class="form-group">
                <label>Episodes Watched</label>
                <div class="episodes-group">
                  <app-number-input
                    [value]="episodesWatched()"
                    [min]="0"
                    [max]="totalEpisodes() > 0 ? totalEpisodes() : undefined"
                    (valueChange)="episodesWatched.set($event)"
                  ></app-number-input>
                  
                  @if (totalEpisodes() > 0 && episodesWatched() < totalEpisodes()) {
                    <button 
                      class="complete-btn" 
                      (click)="markAsComplete()" 
                      title="Mark as Complete"
                    >
                      <lucide-icon [img]="CheckCircleIcon" [size]="18"></lucide-icon>
                    </button>
                  }
                </div>
              </div>

              <div class="form-group">
                <label>Total Episodes</label>
                <app-number-input
                  [value]="totalEpisodes()"
                  [min]="0"
                  (valueChange)="totalEpisodes.set($event)"
                ></app-number-input>
              </div>

              <div class="form-group">
                <label>Score (0-11)</label>
                <app-number-input
                  [value]="score()"
                  [min]="0"
                  [max]="11"
                  (valueChange)="score.set($event)"
                ></app-number-input>
              </div>

              <div class="form-group">
                <label>Release Year</label>
                <app-number-input
                  [value]="releaseYear() || 0"
                  [min]="1900"
                  [max]="2100"
                  placeholder="YYYY"
                  (valueChange)="releaseYear.set($event || undefined)"
                ></app-number-input>
              </div>

              <div class="form-group full-width">
                <label>Studios</label>
                <app-tag-input
                  [tags]="studios()"
                  (tagsChange)="studios.set($event)"
                  placeholder="Studio Name..."
                ></app-tag-input>
              </div>

              <div class="form-group full-width">
                <label>Genres (Press Enter or Comma to add)</label>
                <app-tag-input
                  [tags]="genres()"
                  (tagsChange)="genres.set($event)"
                  placeholder="Action, Adventure..."
                ></app-tag-input>
              </div>

              <div class="form-group full-width">
                <label>Watch Dates</label>
                <div class="watch-date-row">
                  <input 
                    type="date" 
                    [value]="newWatchDate()" 
                    (input)="newWatchDate.set($any($event.target).value)" 
                    class="date-input"
                  />
                  <button type="button" class="add-date-btn-form" (click)="addDate()">Add</button>
                </div>
                
                @if (watchDates().length > 0) {
                  <div class="date-chips">
                    @for (date of watchDates(); track date; let i = $index) {
                      <div class="date-chip">
                        {{ date | date:'mediumDate' }}
                        <button type="button" class="remove-date" (click)="removeDate(i)">
                          <lucide-icon [img]="XIcon" [size]="12"></lucide-icon>
                        </button>
                      </div>
                    }
                  </div>
                }
              </div>

              <div class="form-group full-width">
                <label>Notes</label>
                <textarea
                  rows="3"
                  [value]="notes()"
                  (input)="notes.set($any($event.target).value)"
                ></textarea>
              </div>
            </div>
          </div>
        }
      </div>

      <div class="dialog-footer">
        <button class="cancel-btn" (click)="close()" [disabled]="isSaving()">
          Cancel
        </button>
        <button
          class="save-btn"
          (click)="save()"
          [disabled]="isSaving() || !title().trim()"
        >
          {{ isSaving() ? 'Saving...' : 'Save' }}
        </button>
      </div>
    </div>
  </div>
}
